# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  app:
    replicas: 1
    pod:
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        fsGroupChangePolicy: OnRootMismatch
    initContainers:
      download-html:
        image:
          repository: jacob.pub/docker.io/curlimages/curl
          tag: 8.16.0@sha256:463eaf6072688fe96ac64fa623fe73e1dbe25d8ad6c34404a669ad3ce1f104b6
        securityContext:
          runAsNonRoot: true
          runAsUser: 101
          runAsGroup: 101
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
        command:
          - /bin/sh
          - -c
          - |
            set -e
            SENSY_VERSION="v1.2.7"
            echo "Downloading zone_editor.html from version ${SENSY_VERSION}..."
            curl -L -o /usr/share/nginx/html/index.html "https://raw.githubusercontent.com/sensy-one/S1/refs/tags/${SENSY_VERSION}/assets/config/zone_editor.html"
            echo "Download complete!"
            ls -lh /usr/share/nginx/html/
    containers:
      app:
        image:
          repository: jacob.pub/docker.io/library/nginx
          tag: 1.28.0-alpine-slim@sha256:ce2bd4775ed6859d35f47d65401ee9f35f1dd00b32ed05f0ce38b68aa1830195
        securityContext:
          runAsNonRoot: true
          runAsUser: 101
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

service:
  app:
    controller: app
    ports:
      http:
        port: 80

persistence:
  nginx-config:
    type: configMap
    name: sensy-zone-editor
    globalMounts:
      - path: /etc/nginx/conf.d/default.conf
        subPath: default.conf
  nginx-html:
    type: persistentVolumeClaim
    storageClass: longhorn-ssd
    accessMode: ReadWriteOnce
    size: 1Gi
    globalMounts:
      - path: /usr/share/nginx/html
  tmp:
    type: emptyDir
    globalMounts:
      - path: /tmp
  nginx-cache:
    type: emptyDir
    advancedMounts:
      app:
        app:
          - path: /var/cache/nginx
  nginx-run:
    type: emptyDir
    advancedMounts:
      app:
        app:
          - path: /var/run

ingress:
  app:
    enabled: true
    className: nginx
    annotations:
      kubernetes.io/tls-acme: "true"
      cert-manager.io/cluster-issuer: cloudflare
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    hosts:
      - host: sensy-zone-editor.mcswain.dev
        paths:
          - path: /
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - sensy-zone-editor.mcswain.dev
        secretName: sensy-zone-editor.mcswain.dev-tls

configMaps:
  nginx-config:
    data:
      default.conf: |
        server {
            listen 80;
            server_name _;

            root /usr/share/nginx/html;
            index index.html;

            location / {
                try_files $uri $uri/ =404;
            }

            # Security headers
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
        }
