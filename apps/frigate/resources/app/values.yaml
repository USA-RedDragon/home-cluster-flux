# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  frigate:
    replicas: 1

    pod:
      priorityClassName: system-cluster-critical
      nodeSelector:
        google.feature.node.kubernetes.io/coral: "true"

    initContainers:
      config-copy:
        image:
          repository: busybox
          tag: 1.36.1
          pullPolicy: IfNotPresent
        command: ["sh", "-c", "cp /configmap/config.yml", "/config/config.yml"]

    containers:
      frigate:
        image:
          repository: jacob.pub/ghcr.io/blakeblackshear/frigate
          tag: "0.16.4@sha256:1f8dbaaa4c7c2855c2aef711842d13b0c20bfdc3f28ad88faf66aa1bc219b108"
        env:
          - name: FRIGATE_MQTT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: frigate
                key: mqtt-password
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true

service:
  frigate:
    controller: frigate
    ports:
      https:
        port: 8971
        primary: true
      http-unauthenticated:
        port: 5000
      rtsp-restream:
        port: 8554
      webrtc-tcp:
        port: 8555
        protocol: TCP
      webrtc-udp:
        port: 8555
        protocol: UDP

configMaps:
  config:
    data:
      config.yml: |
        mqtt:
          # Required: host name
          host: mosquitto.mosquitto
          port: 1883
          topic_prefix: frigate
          client_id: frigate
          user: frigate
          stats_interval: 60

        detectors:
          coral:
            type: edgetpu
            device: usb
          cpu1:
            type: cpu

        # cameras:
        #   # Name of your camera
        #   front_door:
        #     ffmpeg:
        #       inputs:
        #         - path: rtsp://{FRIGATE_RSTP_USERNAME}:{FRIGATE_RTSP_PASSWORD}@10.0.10.10:554/cam/realmonitor?channel=1&subtype=2
        #           roles:
        #             - detect
        #             - rtmp
        #     width: 1280
        #     height: 720
        #     fps: 5

persistence:
  configmap:
    enabled: true
    type: configMap
    name: frigate
    advancedMounts:
      frigate:
        config-copy:
          - path: /configmap
  config:
    enabled: true
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 10Gi
  tmp:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 1Gi
  shm:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 2Gi
    globalMounts:
      - path: /dev/shm
  nvr:
    enabled: true
    type: nfs
    path: /mnt/data/frigate
    server: 192.168.1.135
    globalMounts:
      - path: /media/frigate
  usb:
    enabled: true
    type: hostPath
    hostPath: /dev/bus/usb
    hostPathType: Directory
    globalMounts:
      - path: /dev/bus/usb
  usb-sys:
    enabled: true
    type: hostPath
    hostPath: /sys/bus/usb
    hostPathType: Directory
    globalMounts:
      - path: /sys/bus/usb

route:
  frigate:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: https
    hostnames:
      - frigate.mcswain.dev
    rules:
      - backendRefs:
          - group: gateway.envoyproxy.io
            kind: Backend
            name: frigate
            port: 8971
        matches:
          - path:
              type: PathPrefix
              value: /
