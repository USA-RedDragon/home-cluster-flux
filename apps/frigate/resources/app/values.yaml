# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  frigate:
    replicas: 1

    pod:
      priorityClassName: system-cluster-critical
      nodeSelector:
        google.feature.node.kubernetes.io/coral: "true"

    initContainers:
      config-copy:
        image:
          repository: busybox
          tag: 1.37.0@sha256:b3255e7dfbcd10cb367af0d409747d511aeb66dfac98cf30e97e87e4207dd76f
          pullPolicy: IfNotPresent
        command: ["sh", "-c", "cp /configmap/config.yml /config/config.yml"]

    containers:
      frigate:
        securityContext:
          privileged: true
        image:
          repository: jacob.pub/ghcr.io/blakeblackshear/frigate
          tag: "0.16.4@sha256:1f8dbaaa4c7c2855c2aef711842d13b0c20bfdc3f28ad88faf66aa1bc219b108"
        env:
          - name: FRIGATE_JWT_SECRET
            valueFrom:
              secretKeyRef:
                name: frigate
                key: jwt-secret
          - name: FRIGATE_MQTT_PASSWORD
            valueFrom:
              secretKeyRef:
                name: frigate
                key: mqtt-password
          - name: FRIGATE_DOORBELL_USERNAME
            valueFrom:
              secretKeyRef:
                name: frigate
                key: doorbell-username
          - name: FRIGATE_DOORBELL_PASSWORD
            valueFrom:
              secretKeyRef:
                name: frigate
                key: doorbell-password
          - name: FRIGATE_DOORBELL_ADDRESS
            valueFrom:
              secretKeyRef:
                name: frigate
                key: doorbell-address
          - name: FRIGATE_AMCREST_USERNAME
            valueFrom:
              secretKeyRef:
                name: frigate
                key: amcrest-username
          - name: FRIGATE_AMCREST_PASSWORD
            valueFrom:
              secretKeyRef:
                name: frigate
                key: amcrest-password
          - name: FRIGATE_BACK_PORCH_ADDRESS
            valueFrom:
              secretKeyRef:
                name: frigate
                key: back-porch-address
          - name: FRIGATE_FRONT_GATE_ADDRESS
            valueFrom:
              secretKeyRef:
                name: frigate
                key: front-gate-address
          - name: FRIGATE_LEFT_DRIVEWAY_ADDRESS
            valueFrom:
              secretKeyRef:
                name: frigate
                key: left-driveway-address
          - name: FRIGATE_SIDE_GATE_ADDRESS
            valueFrom:
              secretKeyRef:
                name: frigate
                key: side-gate-address
          - name: FRIGATE_PROXY_SECRET
            valueFrom:
              secretKeyRef:
                name: frigate
                key: proxy-secret
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true

service:
  frigate:
    controller: frigate
    ports:
      https:
        port: 8971
        primary: true
      http-unauthenticated:
        port: 5000
      rtsp-restream:
        port: 8554
      webrtc-tcp:
        port: 8555
        protocol: TCP
      webrtc-udp:
        port: 8555
        protocol: UDP

serviceMonitor:
  frigate:
    enabled: true
    serviceName: frigate
    endpoints:
      - port: http-unauthenticated
        scheme: http
        path: /api/metrics
        interval: 10s
        scrapeTimeout: 10s

configMaps:
  config:
    data:
      config.yml: |
        mqtt:
          host: mosquitto.mosquitto
          port: 1883
          topic_prefix: frigate
          password: '{FRIGATE_MQTT_PASSWORD}'
          client_id: frigate
          user: frigate
          stats_interval: 60

        detectors:
          coral:
            type: edgetpu
            device: usb

        birdseye:
          enabled: true
          mode: continuous

        record:
          enabled: true
          retain:
            days: 30
            mode: all
          alerts:
            retain:
              days: 90
          detections:
            retain:
              days: 90

        snapshots:
          enabled: true
          retain:
            default: 90

        auth:
          enabled: false
          trusted_proxies:
            - 172.17.0.0/16

        proxy:
          auth_secret: '{FRIGATE_PROXY_SECRET}'
          header_map:
            user: X-authentik-username
            role: X-authentik-groups

        go2rtc:
          webrtc:
            candidates:
              - frigate.mcswain.dev:8555
              - 192.168.254.254:8555
              - frigate.mcswain.internal:8555
              - 192.168.254.253:8555
              - stun:8555
          streams:
            doorbell:
              - ffmpeg:http://{FRIGATE_DOORBELL_ADDRESS}/flv?port=1935&app=bcs&stream=channel0_main.bcs&user={FRIGATE_DOORBELL_USERNAME}&password={FRIGATE_DOORBELL_PASSWORD}#video=copy#audio=copy#audio=opus
              - rtsp://{FRIGATE_DOORBELL_USERNAME}:{FRIGATE_DOORBELL_PASSWORD}@{FRIGATE_DOORBELL_ADDRESS}/Preview_01_sub
            doorbell_sub:
              - ffmpeg:http://{FRIGATE_DOORBELL_ADDRESS}/flv?port=1935&app=bcs&stream=channel0_ext.bcs&user={FRIGATE_DOORBELL_USERNAME}&password={FRIGATE_DOORBELL_PASSWORD}
              - rtsp://{FRIGATE_DOORBELL_USERNAME}:{FRIGATE_DOORBELL_PASSWORD}@{FRIGATE_DOORBELL_ADDRESS}/Preview_01_sub
            back_porch:
              - ffmpeg:rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_BACK_PORCH_ADDRESS}/cam/realmonitor?channel=1&subtype=0#video=copy#audio=copy
            back_porch_sub:
              - rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_BACK_PORCH_ADDRESS}/cam/realmonitor?channel=1&subtype=2
            front_gate:
              - ffmpeg:rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_FRONT_GATE_ADDRESS}/cam/realmonitor?channel=1&subtype=0#video=copy#audio=copy
            front_gate_sub:
              - rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_FRONT_GATE_ADDRESS}/cam/realmonitor?channel=1&subtype=2
            left_driveway:
              - ffmpeg:rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_LEFT_DRIVEWAY_ADDRESS}/cam/realmonitor?channel=1&subtype=0#video=copy#audio=copy
            left_driveway_sub:
              - rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_LEFT_DRIVEWAY_ADDRESS}/cam/realmonitor?channel=1&subtype=2
            side_gate:
              - ffmpeg:rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_SIDE_GATE_ADDRESS}/cam/realmonitor?channel=1&subtype=0#video=copy#audio=copy
            side_gate_sub:
              - rtsp://{FRIGATE_AMCREST_USERNAME}:{FRIGATE_AMCREST_PASSWORD}@{FRIGATE_SIDE_GATE_ADDRESS}/cam/realmonitor?channel=1&subtype=2

        cameras:
          doorbell:
            ffmpeg:
              inputs:
                - path: rtsp://127.0.0.1:8554/doorbell
                  input_args: preset-rtsp-restream
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/doorbell_sub
                  input_args: preset-rtsp-restream
                  roles:
                    - detect
            detect:
              enabled: true
            motion:
              threshold: 30
              contour_area: 26
              improve_contrast: true
              mask: 0.374,0.492,0.374,0.517,0.4,0.517,0.401,0.489
            zones:
              Yard:
                coordinates:
                  0.002,0.998,0.071,0.998,0.205,0.863,0.234,0.868,0.413,0.637,0.643,0.627,0.582,0.585,0.291,0.595,0.001,0.713
                loitering_time: 0
                inertia: 3
              Porch:
                coordinates:
                  0.409,0.644,0.648,0.635,1,0.976,0.999,0.998,0.073,1,0.203,0.866,0.234,0.865
                loitering_time: 0
              Street:
                coordinates: 0.144,0.569,0.131,0.592,0.643,0.593,0.638,0.556
                loitering_time: 0
            objects:
              filters:
                person:
                  mask: 0.319,0.527,0.317,0.56,0.36,0.564,0.362,0.53
          back_porch:
            ffmpeg:
              inputs:
                - path: rtsp://127.0.0.1:8554/back_porch
                  input_args: preset-rtsp-restream
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/back_porch_sub
                  input_args: preset-rtsp-restream
                  roles:
                    - detect
            detect:
              enabled: true
            zones:
              Back_Porch:
                coordinates: 0.163,0.501,0.49,0.421,0.958,1,0.209,1
                loitering_time: 0
              Back_Yard:
                coordinates:
                  0.175,0.495,0.491,0.419,0.961,1,0.998,1,1,0.533,0.652,0.287,0.585,0.296,0.556,0.22,0.441,0.241,0.395,0.211,0.178,0.245
                loitering_time: 0
                inertia: 3
            motion:
              mask: 0.192,0.024,0.19,0.114,0.574,0.128,1,0.38,1,0.105
          front_gate:
            ffmpeg:
              inputs:
                - path: rtsp://127.0.0.1:8554/front_gate
                  input_args: preset-rtsp-restream
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/front_gate_sub
                  input_args: preset-rtsp-restream
                  roles:
                    - detect
            detect:
              enabled: true
            zones:
              Yard:
                coordinates:
                  0.203,0.224,0.197,0.362,0.248,0.997,0.96,0.996,0.996,0.853,0.998,0.703,0.451,0.156
                loitering_time: 0
              Street:
                coordinates:
                  0.193,0.221,0.188,0.16,0.386,0.111,0.569,0.095,0.726,0.113,0.861,0.152,0.911,0.166,0.936,0.179,0.952,0.211,0.928,0.211,0.84,0.18,0.747,0.158,0.552,0.147,0.452,0.15
                loitering_time: 0
              Neighbor_Yard:
                coordinates:
                  0.454,0.151,0.548,0.248,0.708,0.407,0.906,0.607,0.998,0.697,0.998,0.359,0.946,0.311,0.944,0.274,0.954,0.226,0.949,0.216,0.759,0.163,0.696,0.156
                loitering_time: 0
          left_driveway:
            ffmpeg:
              inputs:
                - path: rtsp://127.0.0.1:8554/left_driveway
                  input_args: preset-rtsp-restream
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/left_driveway_sub
                  input_args: preset-rtsp-restream
                  roles:
                    - detect
            detect:
              enabled: true
            zones:
              Driveway:
                coordinates:
                  0.257,0.29,0.324,0.283,0.353,0.397,0.816,0.379,0.998,0.568,0.842,0.802,0.623,0.998,0.267,0.996,0.257,0.952,0.241,0.898,0.241,0.43,0.259,0.415
                loitering_time: 0
              Far_Yard:
                coordinates:
                  0.256,0.235,0.607,0.223,0.803,0.372,0.354,0.397,0.327,0.283,0.256,0.289
                loitering_time: 0
              Near_Yard:
                coordinates: 0.998,0.575,0.853,0.792,0.63,0.998,0.998,0.997
                loitering_time: 0
              Street:
                coordinates:
                  0.435,0.095,0.503,0.125,0.58,0.155,0.71,0.208,0.825,0.278,1,0.428,0.998,0.559,0.806,0.367,0.611,0.223,0.392,0.114
                loitering_time: 0
              Clint_Yard:
                coordinates: 0.258,0.231,0.598,0.22,0.469,0.154,0.257,0.151
                loitering_time: 0
            motion:
              mask: 0.838,0.134,0.838,0.167,0.873,0.179,0.874,0.146
            objects:
              filters:
                person:
                  mask: 0.704,0.148,0.706,0.203,0.751,0.228,0.753,0.158
          side_gate:
            ffmpeg:
              inputs:
                - path: rtsp://127.0.0.1:8554/side_gate
                  input_args: preset-rtsp-restream
                  roles:
                    - record
                - path: rtsp://127.0.0.1:8554/side_gate_sub
                  input_args: preset-rtsp-restream
                  roles:
                    - detect
            detect:
              enabled: true
            zones:
              Side_Yard:
                coordinates:
                  0.248,0.291,0.281,0.673,0.336,0.997,0.998,0.992,0.998,0.45,0.495,0.168,0.251,0.229
                loitering_time: 0
            motion:
              mask:
                - 0.673,0.002,0.676,0.101,0.763,0.117,0.773,0.005
                - 0.848,0.031,0.851,0.144,0.997,0.234,0.998,0.093
        detect:
          enabled: true
        version: 0.16-0

persistence:
  configmap:
    enabled: true
    type: configMap
    name: frigate
    advancedMounts:
      frigate:
        config-copy:
          - path: /configmap
  config:
    enabled: true
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 10Gi
  tmp:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 1Gi
  shm:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 2Gi
    globalMounts:
      - path: /dev/shm
  nvr:
    enabled: true
    type: nfs
    path: /mnt/data/frigate
    server: 192.168.1.135
    globalMounts:
      - path: /media/frigate
  usb:
    enabled: true
    type: hostPath
    hostPath: /dev/bus/usb
    hostPathType: Directory
    globalMounts:
      - path: /dev/bus/usb
  usb-sys:
    enabled: true
    type: hostPath
    hostPath: /sys/bus/usb
    hostPathType: Directory
    globalMounts:
      - path: /sys/bus/usb

route:
  frigate:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: https
    hostnames:
      - frigate.mcswain.dev
    rules:
      - backendRefs:
          - group: gateway.envoyproxy.io
            kind: Backend
            name: frigate
            port: 8971
        matches:
          - path:
              type: PathPrefix
              value: /
  frigate-unauthenticated:
    enabled: true
    kind: TCPRoute
    parentRefs:
      - name: internal
        namespace: envoy-gateway-system
        sectionName: frigate-unauthenticated
    rules:
      - backendRefs:
          - name: frigate
            port: 5000
  frigate-rtsp:
    enabled: true
    kind: TCPRoute
    parentRefs:
      - name: internal
        namespace: envoy-gateway-system
        sectionName: frigate-rtsp
    rules:
      - backendRefs:
          - name: frigate
            port: 8554
  frigate-webrtc-tcp:
    enabled: true
    kind: TCPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: frigate-webrtc-tcp
    rules:
      - backendRefs:
          - name: frigate
            port: 8555
  frigate-webrtc-udp:
    enabled: true
    kind: UDPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: frigate-webrtc-udp
    rules:
      - backendRefs:
          - name: frigate
            port: 8555
  frigate-internal-webrtc-tcp:
    enabled: true
    kind: TCPRoute
    parentRefs:
      - name: internal
        namespace: envoy-gateway-system
        sectionName: frigate-webrtc-tcp
    rules:
      - backendRefs:
          - name: frigate
            port: 8555
  frigate-internal-webrtc-udp:
    enabled: true
    kind: UDPRoute
    parentRefs:
      - name: internal
        namespace: envoy-gateway-system
        sectionName: frigate-webrtc-udp
    rules:
      - backendRefs:
          - name: frigate
            port: 8555
