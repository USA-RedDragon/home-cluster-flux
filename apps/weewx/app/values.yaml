# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  weewx:
    replicas: 1
    pod:
      annotations:
        app.kubernetes.io/name: weewx
      labels:
        policy.mcswain.dev/egress-coredns: "true"
        policy.mcswain.dev/egress-internet: "true"
        policy.mcswain.dev/egress-namespace: "true"
        policy.mcswain.dev/ingress-nginx: "true"
        mariadb-client: "true"
      securityContext:
        fsGroup: 1000
    containers:
      weewx:
        image:
          repository: jacob.pub/ghcr.io/usa-reddragon/weewx
          tag: 5.1.0@sha256:fe6b548275423a3e3033231d949c7130c2e1b0a8e4fc66c99ccd5efa77824f68
          pullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - ln -sf /usr/share/zoneinfo/$TZ /etc/localtime && exec /bin/s6-svscan /etc/s6
        resources:
          limits:
            memory: 500Mi
          requests:
            cpu: '1'
            memory: 300Mi
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
        env:
          - name: TZ
            value: America/Chicago
          - name: CONFIG_OVERRIDE
            value: "/config/weewx.conf"

service:
  weewx:
    controller: weewx
    ports:
      http:
        port: 3000

persistence:
  html:
    type: persistentVolumeClaim
    storageClass: longhorn-ssd
    size: 1Gi
    accessMode: ReadWriteOnce
    globalMounts:
      - path: /var/www/html/weewx
  data:
    type: persistentVolumeClaim
    storageClass: longhorn-nvme
    size: 10Gi
    accessMode: ReadWriteOnce
    globalMounts:
      - path: /var/lib/weewx
  config:
    type: secret
    name: weewx-config

route:
  weewx:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: https
    hostnames:
      - wx.mcswain.dev
    rules:
      - backendRefs:
          - name: weewx
            port: 3000
        matches:
          - path:
              type: PathPrefix
              value: /
