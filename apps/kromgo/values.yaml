# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  kromgo:
    replicas: 1
    containers:
      kromgo:
        image:
          repository: jacob.pub/ghcr.io/kashalls/kromgo
          tag: v0.7.4
          pullPolicy: IfNotPresent
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 20m
            memory: 50Mi
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
        env:
          - name: PROMETHEUS_URL
            value: http://prometheus-stack-kube-prom-prometheus.monitoring.svc.cluster.local:9090
          - name: SERVER_HOST
            value: 0.0.0.0
          - name: HEALTH_HOST
            value: 0.0.0.0

service:
  kromgo:
    controller: kromgo
    ports:
      http:
        port: 8080

configMaps:
  config:
    data:
      config.yaml: |
        metrics:
          - name: Nodes
            query: count(count by(node) (kube_node_status_condition{condition="Ready"}))

          - name: Pods
            query: sum(kube_pod_status_phase{phase="Running"})

          - name: CPU
            query: round(sum(avg(instance:node_cpu_utilisation:rate5m)*100), 0.1)
            suffix: "%"
            colors:
              - { color: "green", min: 0, max: 20 }
              - { color: "orange", min: 21, max: 30 }
              - { color: "red", min: 31, max: 9999 }

          - name: Total CPUs
            query: sum(instance:node_num_cpu:sum{})

          - name: Memory
            query: round(sum(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / sum(node_memory_MemTotal_bytes) * 100, 0.1)
            suffix: "%"
            colors:
              - { color: green, min: 0, max: 55 }
              - { color: orange, min: 56, max: 75 }
              - { color: red, min: 76, max: 9999 }

          - name: Total Memory
            query: round(sum(node_memory_MemTotal_bytes)/1024/1024/1024, 0.1)
            suffix: "GiB"

          - name: Disk Latency
            query: round(((avg(longhorn_volume_write_latency{})+avg(longhorn_volume_read_latency{}))/2)/1000000, 0.1)
            suffix: "ms"

          - name: Disk Throughput
            query: round(((avg(longhorn_volume_write_throughput{})+avg(longhorn_volume_read_throughput{}))/2)/1024/1024, 0.1)
            suffix: "MiB/s"

          - name: Disk Capacity
            query: round(sum(longhorn_node_storage_capacity_bytes{})/1024/1024/1024/1024, 0.1)
            suffix: "TiB"

          - name: Disk Reserved
            query: round(sum(longhorn_node_storage_reservation_bytes{})/1024/1024/1024/1024, 0.1)
            suffix: "TiB"

          - name: Disk Usage
            query: round((sum(longhorn_node_storage_reservation_bytes{} + longhorn_node_storage_usage_bytes) / sum(longhorn_node_storage_capacity_bytes))*100, 0.1)
            colors:
              - { color: green, min: 0, max: 55 }
              - { color: orange, min: 56, max: 75 }
              - { color: red, min: 76, max: 9999 }
            suffix: "%"

persistence:
  config:
    enabled: true
    type: configMap
    name: kromgo
    advancedMounts:
      zot:
        zot:
          - path: /kromgo/config.yaml
            subPath: config.yaml

route:
  kromgo:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: public
        namespace: envoy-gateway-system
        sectionName: https
    hostnames:
      - git.mcswain.dev
    rules:
      - backendRefs:
          - name: kromgo
            port: 8080
        matches:
          - path:
              type: PathPrefix
              value: /
