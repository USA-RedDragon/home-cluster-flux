# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.4.0/charts/other/app-template/schemas/helmrelease-helm-v2beta2.schema.json

controllers:
  ephemeris:
    type: cronjob
    cronjob:
      schedule: "*/5 * * * *"
      concurrencyPolicy: Forbid
    pod:
      imagePullSecrets:
        - name: registry-docker-hub
      securityContext:
        fsGroup: 65535
    initContainers:
      ephemeris:
        image:
          repository: ghcr.io/usa-reddragon/ephemeris
          tag: v1.1.3@sha256:f0e9fee7f42b33bf4aff2249884b138851a86bd9796d3f707aec74406b2f62ea
          pullPolicy: IfNotPresent
        env:
          TIME_ZONE: America/Chicago
          TZ: America/Chicago
          DOC_PAGE_DIMENSIONS: 480x800
          DOC_PAGE_DPI: '125'
          DOC_COVER_ENABLED: false
          TIME_DISPLAY_START: '8'
          DOC_MINICAL_MODE: current
          DOC_ALLDAY_BOUNDARY: margin
          DOC_EVENT_FILL_COLOR: "#ffffff"
          TIME_DISPLAY_END: '18'
          APP_OUTPUT_FORMAT: png
          APP_META_FILE_PATH: /tmp/feeds_meta.yaml
          TIME_FORMAT: '12'
          DOC_FOOTER_TEXT: updatedat
          DOC_FOOTER_COLOR: black
          DOC_EVENT_BORDER_COLOR: black
          DOC_GRID_LINE_COLOR: black
          DOC_MONOCHROME: 'true'
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          runAsGroup: 65535
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
    containers:
      process-and-upload:
        image:
          repository: alpine
          tag: 3.21.3
          pullPolicy: IfNotPresent
        securityContext:
          capabilities:
            drop:
              - ALL
        envFrom:
          - secretRef:
              name: ephemeris-s3
        command:
          - /bin/sh
          - -c
          - |
            apk add --no-cache aws-cli imagemagick netpbm
            magick /app/output/png/ephemeris_$(date +%F).png -colors 2 -depth 1 -strip pbm:- | ppmtobmp -bpp 1 > /tmp/ephemeris.bmp
            aws s3 --endpoint-url https://s3.mcswain.dev cp /tmp/ephemeris.bmp s3://ephemeris/ephemeris.bmp
            aws s3 --endpoint-url https://s3.mcswain.dev cp /app/output/png/ephemeris_$(date +%F).png s3://ephemeris/

persistence:
  output:
    enabled: true
    type: emptyDir
    sizeLimit: 1Gi
    globalMounts:
      - path: /app/output
  tmp:
    enabled: true
    type: emptyDir
    medium: Memory
    sizeLimit: 1Gi
    globalMounts:
      - path: /tmp
  config:
    enabled: true
    type: secret
    name: ephemeris-config
    items:
      - key: config.yaml
        path: config.yaml
    globalMounts:
      - path: /app/config.yaml
        subPath: config.yaml
