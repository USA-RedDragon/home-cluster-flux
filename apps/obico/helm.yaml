---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: obico
  namespace: obico
spec:
  interval: 1m0s
  url: https://charts.gabe565.com
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: obico
  namespace: obico
spec:
  install:
    remediation:
      retries: -1
  chart:
    spec:
      chart: obico
      version: 0.6.0
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: obico
        name: obico
  interval: 1h
  driftDetection:
    mode: enabled
  suspend: false
  values:
    redis:
      enabled: false
    ml-api:
      image:
        repository: jacob.pub/ghcr.io/gabe565/obico/ml-api
    server:
      image:
        repository: jacob.pub/ghcr.io/gabe565/obico/web
      env:
        EMAIL_HOST: email.mcswain.dev
        EMAIL_HOST_USER: obico
        DEFAULT_FROM_EMAIL: obico@mcswain.dev
        EMAIL_PORT: '465'
        EMAIL_USE_TLS: 'False'
        EMAIL_USE_SSL: 'True'
        REDIS_PASSWORD:
          secretKeyRef:
            name: valkey
            key: valkey-password
        REDIS_URL: redis://:$(REDIS_PASSWORD)@valkey:6379
      envFrom:
        - secretRef:
            name: obico

      podLabels:
        valkey-client: "true"

      persistence:
        data:
          enabled: true
          storageClass: longhorn-ssd
          accessMode: ReadWriteOnce
          size: 512M
        media:
          enabled: true
          storageClass: longhorn-nvme
          accessMode: ReadWriteOnce
          size: 8Gi

      ingress:
        tailscale:
          enabled: true
          ingressClassName: tailscale
          hosts:
            - host: obico
              paths:
                - path: /
          tls:
            - hosts:
                - obico