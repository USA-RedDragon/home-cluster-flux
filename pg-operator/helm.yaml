---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: postgres-operator-charts
  namespace: pg-operator
spec:
  interval: 1m0s
  url: https://opensource.zalando.com/postgres-operator/charts/postgres-operator
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: pg-operator
  namespace: pg-operator
spec:
  interval: 1m0s
  releaseName: pg-operator
  chart:
    spec:
      chart: postgres-operator
      sourceRef:
        kind: HelmRepository
        name: postgres-operator-charts
      version: '>=1.10.1 <2.0.0'
      interval: 1m0s
  values:
    image:
      registry: ghcr.io
      repository: usa-reddragon/postgres-operator
      tag: v1.10.2
    imagePullSecrets:
      - name: registry-docker-hub
    configGeneral:
      min_instances: 2
      max_instances: 3
      enable_crd_registration: false
    # configUsers:
    #   # enable_password_rotation: true
    configMajorVersionUpgrade:
      major_version_upgrade_mode: manual
    configKubernetes:
      enable_cross_namespace_secret: true
      enable_pod_antiaffinity: true
      enable_readiness_probe: true
      pod_environment_secret: postgresql-pod-environment
      storage_resize_mode: off
      ignored_annotations:
      - metallb.universe.tf/ip-allocated-from-pool
    configLoadBalancer:
      db_hosted_zone: db.mcswain.dev
      enable_master_load_balancer: true
      external_traffic_policy: "Local"
    configLogicalBackup:
      logical_backup_provider: "s3"
      logical_backup_s3_access_key_id: "Ejty0NAE233siQrbdoVT"
      logical_backup_s3_secret_access_key: ""
      logical_backup_s3_bucket: "pg-operator-backups"
      logical_backup_s3_endpoint: "https://s3.mcswain.dev"
      logical_backup_s3_retention_time: "2 week"
      logical_backup_schedule: "00/30 * * * *"
    configAwsOrGcp:
      aws_region:
      wal_s3_bucket: "pg-operator-wal"
      log_s3_bucket: "pg-operator-logs"
    configPatroni:
      enable_patroni_failsafe_mode: true
